app-id: dev.corgiterm.CorgiTerm
runtime: org.gnome.Platform
runtime-version: '46'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: corgiterm

finish-args:
  # X11 + Wayland
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  # GPU acceleration
  - --device=dri
  # Network access (for AI features, SSH)
  - --share=network
  # PTY/terminal access
  - --talk-name=org.freedesktop.Flatpak
  # Filesystem access
  - --filesystem=home
  - --filesystem=/tmp
  # dconf for GTK settings
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  # SSH agent
  - --socket=ssh-auth
  # Notifications
  - --talk-name=org.freedesktop.Notifications

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
  env:
    CARGO_HOME: /run/build/corgiterm/cargo
    RUST_BACKTRACE: '1'

modules:
  # VTE library (GTK4 terminal widget)
  - name: vte
    buildsystem: meson
    config-opts:
      - -Dgtk4=true
      - -Dgtk3=false
      - -Dvapi=false
      - -Ddocs=false
    sources:
      - type: archive
        url: https://download.gnome.org/sources/vte/0.76/vte-0.76.0.tar.xz
        sha256: bbce30b8f504370b12d6439c07a82993e97d7e892ee89ab40e63a17a3c31cf51

  # CorgiTerm
  - name: corgiterm
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm755 target/release/corgiterm -t /app/bin/
      - install -Dm644 flatpak/dev.corgiterm.CorgiTerm.desktop -t /app/share/applications/
      - install -Dm644 flatpak/dev.corgiterm.CorgiTerm.metainfo.xml -t /app/share/metainfo/
      - install -Dm644 flatpak/icons/hicolor/scalable/apps/dev.corgiterm.CorgiTerm.svg -t /app/share/icons/hicolor/scalable/apps/
    sources:
      - type: dir
        path: ..
      # Cargo dependencies (generated with flatpak-cargo-generator.py)
      - cargo-sources.json
